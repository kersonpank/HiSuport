{"ast":null,"code":"import React,{useState,useEffect,useRef,useContext}from\"react\";import*as Yup from\"yup\";import{Formik,Form,Field}from\"formik\";import{toast}from\"react-toastify\";import{head}from\"lodash\";import{makeStyles}from\"@material-ui/core/styles\";import{green}from\"@material-ui/core/colors\";import Button from\"@material-ui/core/Button\";import IconButton from\"@material-ui/core/IconButton\";import TextField from\"@material-ui/core/TextField\";import Dialog from\"@material-ui/core/Dialog\";import DialogActions from\"@material-ui/core/DialogActions\";import DialogContent from\"@material-ui/core/DialogContent\";import DialogTitle from\"@material-ui/core/DialogTitle\";import CircularProgress from\"@material-ui/core/CircularProgress\";import AttachFileIcon from\"@material-ui/icons/AttachFile\";import DeleteOutlineIcon from\"@material-ui/icons/DeleteOutline\";import{i18n}from\"../../translate/i18n\";import moment from\"moment\";import api from\"../../services/api\";import toastError from\"../../errors/toastError\";import{Box,FormControl,Grid,InputLabel,MenuItem,Select,Tab,Tabs}from\"@material-ui/core\";import{AuthContext}from\"../../context/Auth/AuthContext\";import ConfirmationModal from\"../ConfirmationModal\";import{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const useStyles=makeStyles(theme=>({root:{display:\"flex\",flexWrap:\"wrap\",backgroundColor:\"#fff\"},tabmsg:{backgroundColor:theme.palette.campaigntab},textField:{marginRight:theme.spacing(1),flex:1},extraAttr:{display:\"flex\",justifyContent:\"center\",alignItems:\"center\"},btnWrapper:{position:\"relative\"},buttonProgress:{color:green[500],position:\"absolute\",top:\"50%\",left:\"50%\",marginTop:-12,marginLeft:-12}}));const CampaignSchema=Yup.object().shape({name:Yup.string().min(2,\"Too Short!\").max(50,\"Too Long!\").required(\"Required\")});const CampaignModal=_ref=>{let{open,onClose,campaignId,initialValues,onSave,resetPagination}=_ref;const classes=useStyles();const isMounted=useRef(true);const{user}=useContext(AuthContext);const{companyId}=user;const initialState={name:\"\",message1:\"\",message2:\"\",message3:\"\",message4:\"\",message5:\"\",confirmationMessage1:\"\",confirmationMessage2:\"\",confirmationMessage3:\"\",confirmationMessage4:\"\",confirmationMessage5:\"\",status:\"INATIVA\",// INATIVA, PROGRAMADA, EM_ANDAMENTO, CANCELADA, FINALIZADA,\nconfirmation:false,scheduledAt:\"\",whatsappId:\"\",contactListId:\"\",companyId};const[campaign,setCampaign]=useState(initialState);const[whatsapps,setWhatsapps]=useState([]);const[contactLists,setContactLists]=useState([]);const[messageTab,setMessageTab]=useState(0);const[attachment,setAttachment]=useState(null);const[confirmationOpen,setConfirmationOpen]=useState(false);const[campaignEditable,setCampaignEditable]=useState(true);const attachmentFile=useRef(null);useEffect(()=>{return()=>{isMounted.current=false;};},[]);useEffect(()=>{if(isMounted.current){if(initialValues){setCampaign(prevState=>{return{...prevState,...initialValues};});}api.get(\"/contact-lists/list\",{params:{companyId}}).then(_ref2=>{let{data}=_ref2;return setContactLists(data);});api.get(\"/whatsapp\",{params:{companyId,session:0}}).then(_ref3=>{let{data}=_ref3;return setWhatsapps(data);});if(!campaignId)return;api.get(\"/campaigns/\".concat(campaignId)).then(_ref4=>{let{data}=_ref4;setCampaign(prev=>{let prevCampaignData=Object.assign({},prev);Object.entries(data).forEach(_ref5=>{let[key,value]=_ref5;if(key===\"scheduledAt\"&&value!==\"\"&&value!==null){prevCampaignData[key]=moment(value).format(\"YYYY-MM-DDTHH:mm\");}else{prevCampaignData[key]=value===null?\"\":value;}});return prevCampaignData;});});}},[campaignId,open,initialValues,companyId]);useEffect(()=>{const now=moment();const scheduledAt=moment(campaign.scheduledAt);const moreThenAnHour=!Number.isNaN(scheduledAt.diff(now))&&scheduledAt.diff(now,\"hour\")>1;const isEditable=campaign.status===\"INATIVA\"||campaign.status===\"PROGRAMADA\"&&moreThenAnHour;setCampaignEditable(isEditable);},[campaign.status,campaign.scheduledAt]);const handleClose=()=>{onClose();setCampaign(initialState);};const handleAttachmentFile=e=>{const file=head(e.target.files);if(file){setAttachment(file);}};const handleSaveCampaign=async values=>{try{const dataValues={};Object.entries(values).forEach(_ref6=>{let[key,value]=_ref6;if(key===\"scheduledAt\"&&value!==\"\"&&value!==null){dataValues[key]=moment(value).format(\"YYYY-MM-DD HH:mm:ss\");}else{dataValues[key]=value===\"\"?null:value;}});if(campaignId){await api.put(\"/campaigns/\".concat(campaignId),dataValues);if(attachment!=null){const formData=new FormData();formData.append(\"file\",attachment);await api.post(\"/campaigns/\".concat(campaignId,\"/media-upload\"),formData);}handleClose();}else{const{data}=await api.post(\"/campaigns\",dataValues);if(attachment!=null){const formData=new FormData();formData.append(\"file\",attachment);await api.post(\"/campaigns/\".concat(data.id,\"/media-upload\"),formData);}if(onSave){onSave(data);}handleClose();}toast.success(i18n.t(\"campaigns.toasts.success\"));}catch(err){console.log(err);toastError(err);}};const deleteMedia=async()=>{if(attachment){setAttachment(null);attachmentFile.current.value=null;}if(campaign.mediaPath){await api.delete(\"/campaigns/\".concat(campaign.id,\"/media-upload\"));setCampaign(prev=>({...prev,mediaPath:null,mediaName:null}));toast.success(i18n.t(\"campaigns.toasts.deleted\"));}};const renderMessageField=identifier=>{return/*#__PURE__*/_jsx(Field,{as:TextField,id:identifier,name:identifier,fullWidth:true,rows:5,label:i18n.t(\"campaigns.dialog.form.\".concat(identifier)),placeholder:i18n.t(\"campaigns.dialog.form.messagePlaceholder\"),multiline:true,variant:\"outlined\",helperText:\"Utilize vari\\xE1veis como {nome}, {numero}, {email} ou defina vari\\xE1veis personalziadas.\",disabled:!campaignEditable&&campaign.status!==\"CANCELADA\"});};const renderConfirmationMessageField=identifier=>{return/*#__PURE__*/_jsx(Field,{as:TextField,id:identifier,name:identifier,fullWidth:true,rows:5,label:i18n.t(\"campaigns.dialog.form.\".concat(identifier)),placeholder:i18n.t(\"campaigns.dialog.form.messagePlaceholder\"),multiline:true,variant:\"outlined\",disabled:!campaignEditable&&campaign.status!==\"CANCELADA\"});};const cancelCampaign=async()=>{try{await api.post(\"/campaigns/\".concat(campaign.id,\"/cancel\"));toast.success(i18n.t(\"campaigns.toasts.cancel\"));setCampaign(prev=>({...prev,status:\"CANCELADA\"}));resetPagination();}catch(err){toast.error(err.message);}};const restartCampaign=async()=>{try{await api.post(\"/campaigns/\".concat(campaign.id,\"/restart\"));toast.success(i18n.t(\"campaigns.toasts.restart\"));setCampaign(prev=>({...prev,status:\"EM_ANDAMENTO\"}));resetPagination();}catch(err){toast.error(err.message);}};return/*#__PURE__*/_jsxs(\"div\",{className:classes.root,children:[/*#__PURE__*/_jsx(ConfirmationModal,{title:i18n.t(\"campaigns.confirmationModal.deleteTitle\"),open:confirmationOpen,onClose:()=>setConfirmationOpen(false),onConfirm:deleteMedia,children:i18n.t(\"campaigns.confirmationModal.deleteMessage\")}),/*#__PURE__*/_jsxs(Dialog,{open:open,onClose:handleClose,fullWidth:true,maxWidth:\"md\",scroll:\"paper\",children:[/*#__PURE__*/_jsx(DialogTitle,{id:\"form-dialog-title\",children:campaignEditable?/*#__PURE__*/_jsx(_Fragment,{children:campaignId?\"\".concat(i18n.t(\"campaigns.dialog.update\")):\"\".concat(i18n.t(\"campaigns.dialog.new\"))}):/*#__PURE__*/_jsx(_Fragment,{children:\"\".concat(i18n.t(\"campaigns.dialog.readonly\"))})}),/*#__PURE__*/_jsx(\"div\",{style:{display:\"none\"},children:/*#__PURE__*/_jsx(\"input\",{type:\"file\",ref:attachmentFile,onChange:e=>handleAttachmentFile(e)})}),/*#__PURE__*/_jsx(Formik,{initialValues:campaign,enableReinitialize:true,validationSchema:CampaignSchema,onSubmit:(values,actions)=>{setTimeout(()=>{handleSaveCampaign(values);actions.setSubmitting(false);},400);},children:_ref7=>{let{values,errors,touched,isSubmitting}=_ref7;return/*#__PURE__*/_jsxs(Form,{children:[/*#__PURE__*/_jsx(DialogContent,{dividers:true,children:/*#__PURE__*/_jsxs(Grid,{spacing:2,container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:12,md:9,item:true,children:/*#__PURE__*/_jsx(Field,{as:TextField,label:i18n.t(\"campaigns.dialog.form.name\"),name:\"name\",error:touched.name&&Boolean(errors.name),helperText:touched.name&&errors.name,variant:\"outlined\",margin:\"dense\",fullWidth:true,className:classes.textField,disabled:!campaignEditable})}),/*#__PURE__*/_jsx(Grid,{xs:12,md:3,item:true,children:/*#__PURE__*/_jsxs(FormControl,{variant:\"outlined\",margin:\"dense\",fullWidth:true,className:classes.formControl,children:[/*#__PURE__*/_jsx(InputLabel,{id:\"confirmation-selection-label\",children:i18n.t(\"campaigns.dialog.form.confirmation\")}),/*#__PURE__*/_jsxs(Field,{as:Select,label:i18n.t(\"campaigns.dialog.form.confirmation\"),placeholder:i18n.t(\"campaigns.dialog.form.confirmation\"),labelId:\"confirmation-selection-label\",id:\"confirmation\",name:\"confirmation\",error:touched.confirmation&&Boolean(errors.confirmation),disabled:!campaignEditable,children:[/*#__PURE__*/_jsx(MenuItem,{value:false,children:\"Desabilitada\"}),/*#__PURE__*/_jsx(MenuItem,{value:true,children:\"Habilitada\"})]})]})}),/*#__PURE__*/_jsx(Grid,{xs:12,md:4,item:true,children:/*#__PURE__*/_jsxs(FormControl,{variant:\"outlined\",margin:\"dense\",fullWidth:true,className:classes.formControl,children:[/*#__PURE__*/_jsx(InputLabel,{id:\"contactList-selection-label\",children:i18n.t(\"campaigns.dialog.form.contactList\")}),/*#__PURE__*/_jsxs(Field,{as:Select,label:i18n.t(\"campaigns.dialog.form.contactList\"),placeholder:i18n.t(\"campaigns.dialog.form.contactList\"),labelId:\"contactList-selection-label\",id:\"contactListId\",name:\"contactListId\",error:touched.contactListId&&Boolean(errors.contactListId),disabled:!campaignEditable,children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:\"Nenhuma\"}),contactLists&&contactLists.map(contactList=>/*#__PURE__*/_jsx(MenuItem,{value:contactList.id,children:contactList.name},contactList.id))]})]})}),/*#__PURE__*/_jsx(Grid,{xs:12,md:4,item:true,children:/*#__PURE__*/_jsxs(FormControl,{variant:\"outlined\",margin:\"dense\",fullWidth:true,className:classes.formControl,children:[/*#__PURE__*/_jsx(InputLabel,{id:\"whatsapp-selection-label\",children:i18n.t(\"campaigns.dialog.form.whatsapp\")}),/*#__PURE__*/_jsxs(Field,{as:Select,label:i18n.t(\"campaigns.dialog.form.whatsapp\"),placeholder:i18n.t(\"campaigns.dialog.form.whatsapp\"),labelId:\"whatsapp-selection-label\",id:\"whatsappId\",name:\"whatsappId\",error:touched.whatsappId&&Boolean(errors.whatsappId),disabled:!campaignEditable,children:[/*#__PURE__*/_jsx(MenuItem,{value:\"\",children:\"Nenhuma\"}),whatsapps&&whatsapps.map(whatsapp=>/*#__PURE__*/_jsx(MenuItem,{value:whatsapp.id,children:whatsapp.name},whatsapp.id))]})]})}),/*#__PURE__*/_jsx(Grid,{xs:12,md:4,item:true,children:/*#__PURE__*/_jsx(Field,{as:TextField,label:i18n.t(\"campaigns.dialog.form.scheduledAt\"),name:\"scheduledAt\",error:touched.scheduledAt&&Boolean(errors.scheduledAt),helperText:touched.scheduledAt&&errors.scheduledAt,variant:\"outlined\",margin:\"dense\",type:\"datetime-local\",InputLabelProps:{shrink:true},fullWidth:true,className:classes.textField,disabled:!campaignEditable})}),/*#__PURE__*/_jsxs(Grid,{xs:12,item:true,children:[/*#__PURE__*/_jsxs(Tabs,{value:messageTab,indicatorColor:\"primary\",textColor:\"primary\",className:classes.tabmsg,onChange:(e,v)=>setMessageTab(v),variant:\"fullWidth\",centered:true,style:{borderRadius:2},children:[/*#__PURE__*/_jsx(Tab,{label:\"Msg. 1\",index:0}),/*#__PURE__*/_jsx(Tab,{label:\"Msg. 2\",index:1}),/*#__PURE__*/_jsx(Tab,{label:\"Msg. 3\",index:2}),/*#__PURE__*/_jsx(Tab,{label:\"Msg. 4\",index:3}),/*#__PURE__*/_jsx(Tab,{label:\"Msg. 5\",index:4})]}),/*#__PURE__*/_jsxs(Box,{style:{paddingTop:20,border:\"none\"},children:[messageTab===0&&/*#__PURE__*/_jsx(_Fragment,{children:values.confirmation?/*#__PURE__*/_jsxs(Grid,{spacing:2,container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:12,md:8,item:true,children:/*#__PURE__*/_jsx(_Fragment,{children:renderMessageField(\"message1\")})}),/*#__PURE__*/_jsx(Grid,{xs:12,md:4,item:true,children:/*#__PURE__*/_jsx(_Fragment,{children:renderConfirmationMessageField(\"confirmationMessage1\")})})]}):/*#__PURE__*/_jsx(_Fragment,{children:renderMessageField(\"message1\")})}),messageTab===1&&/*#__PURE__*/_jsx(_Fragment,{children:values.confirmation?/*#__PURE__*/_jsxs(Grid,{spacing:2,container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:12,md:8,item:true,children:/*#__PURE__*/_jsx(_Fragment,{children:renderMessageField(\"message2\")})}),/*#__PURE__*/_jsx(Grid,{xs:12,md:4,item:true,children:/*#__PURE__*/_jsx(_Fragment,{children:renderConfirmationMessageField(\"confirmationMessage2\")})})]}):/*#__PURE__*/_jsx(_Fragment,{children:renderMessageField(\"message2\")})}),messageTab===2&&/*#__PURE__*/_jsx(_Fragment,{children:values.confirmation?/*#__PURE__*/_jsxs(Grid,{spacing:2,container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:12,md:8,item:true,children:/*#__PURE__*/_jsx(_Fragment,{children:renderMessageField(\"message3\")})}),/*#__PURE__*/_jsx(Grid,{xs:12,md:4,item:true,children:/*#__PURE__*/_jsx(_Fragment,{children:renderConfirmationMessageField(\"confirmationMessage3\")})})]}):/*#__PURE__*/_jsx(_Fragment,{children:renderMessageField(\"message3\")})}),messageTab===3&&/*#__PURE__*/_jsx(_Fragment,{children:values.confirmation?/*#__PURE__*/_jsxs(Grid,{spacing:2,container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:12,md:8,item:true,children:/*#__PURE__*/_jsx(_Fragment,{children:renderMessageField(\"message4\")})}),/*#__PURE__*/_jsx(Grid,{xs:12,md:4,item:true,children:/*#__PURE__*/_jsx(_Fragment,{children:renderConfirmationMessageField(\"confirmationMessage4\")})})]}):/*#__PURE__*/_jsx(_Fragment,{children:renderMessageField(\"message4\")})}),messageTab===4&&/*#__PURE__*/_jsx(_Fragment,{children:values.confirmation?/*#__PURE__*/_jsxs(Grid,{spacing:2,container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:12,md:8,item:true,children:/*#__PURE__*/_jsx(_Fragment,{children:renderMessageField(\"message5\")})}),/*#__PURE__*/_jsx(Grid,{xs:12,md:4,item:true,children:/*#__PURE__*/_jsx(_Fragment,{children:renderConfirmationMessageField(\"confirmationMessage5\")})})]}):/*#__PURE__*/_jsx(_Fragment,{children:renderMessageField(\"message5\")})})]})]}),(campaign.mediaPath||attachment)&&/*#__PURE__*/_jsxs(Grid,{xs:12,item:true,children:[/*#__PURE__*/_jsx(Button,{startIcon:/*#__PURE__*/_jsx(AttachFileIcon,{}),children:attachment!=null?attachment.name:campaign.mediaName}),campaignEditable&&/*#__PURE__*/_jsx(IconButton,{onClick:()=>setConfirmationOpen(true),color:\"secondary\",children:/*#__PURE__*/_jsx(DeleteOutlineIcon,{})})]})]})}),/*#__PURE__*/_jsxs(DialogActions,{children:[campaign.status===\"CANCELADA\"&&/*#__PURE__*/_jsx(Button,{color:\"primary\",onClick:()=>restartCampaign(),variant:\"outlined\",children:i18n.t(\"campaigns.dialog.buttons.restart\")}),campaign.status===\"EM_ANDAMENTO\"&&/*#__PURE__*/_jsx(Button,{color:\"primary\",onClick:()=>cancelCampaign(),variant:\"outlined\",children:i18n.t(\"campaigns.dialog.buttons.cancel\")}),!attachment&&!campaign.mediaPath&&campaignEditable&&/*#__PURE__*/_jsx(Button,{color:\"primary\",onClick:()=>attachmentFile.current.click(),disabled:isSubmitting,variant:\"outlined\",children:i18n.t(\"campaigns.dialog.buttons.attach\")}),/*#__PURE__*/_jsx(Button,{onClick:handleClose,color:\"secondary\",disabled:isSubmitting,variant:\"outlined\",children:i18n.t(\"campaigns.dialog.buttons.close\")}),(campaignEditable||campaign.status===\"CANCELADA\")&&/*#__PURE__*/_jsxs(Button,{type:\"submit\",color:\"primary\",disabled:isSubmitting,variant:\"contained\",className:classes.btnWrapper,children:[campaignId?\"\".concat(i18n.t(\"campaigns.dialog.buttons.edit\")):\"\".concat(i18n.t(\"campaigns.dialog.buttons.add\")),isSubmitting&&/*#__PURE__*/_jsx(CircularProgress,{size:24,className:classes.buttonProgress})]})]})]});}})]})]});};export default CampaignModal;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}