{"ast":null,"code":"import React,{useState,useEffect,useReducer,useContext,useRef}from\"react\";import{toast}from\"react-toastify\";import{useParams,useHistory}from\"react-router-dom\";import{makeStyles}from\"@material-ui/core/styles\";import Table from\"@material-ui/core/Table\";import TableBody from\"@material-ui/core/TableBody\";import TableCell from\"@material-ui/core/TableCell\";import TableHead from\"@material-ui/core/TableHead\";import TableRow from\"@material-ui/core/TableRow\";import Paper from\"@material-ui/core/Paper\";import Button from\"@material-ui/core/Button\";import SearchIcon from\"@material-ui/icons/Search\";import TextField from\"@material-ui/core/TextField\";import InputAdornment from\"@material-ui/core/InputAdornment\";import IconButton from\"@material-ui/core/IconButton\";import DeleteOutlineIcon from\"@material-ui/icons/DeleteOutline\";import EditIcon from\"@material-ui/icons/Edit\";import CheckCircleIcon from\"@material-ui/icons/CheckCircle\";import BlockIcon from\"@material-ui/icons/Block\";import api from\"../../services/api\";import TableRowSkeleton from\"../../components/TableRowSkeleton\";import ContactListItemModal from\"../../components/ContactListItemModal\";import ConfirmationModal from\"../../components/ConfirmationModal/\";import{i18n}from\"../../translate/i18n\";import MainHeader from\"../../components/MainHeader\";import Title from\"../../components/Title\";import MainContainer from\"../../components/MainContainer\";import toastError from\"../../errors/toastError\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{Can}from\"../../components/Can\";import useContactLists from\"../../hooks/useContactLists\";import{Grid}from\"@material-ui/core\";import planilhaExemplo from\"../../assets/planilha.xlsx\";import{socketConnection}from\"../../services/socket\";import{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";const reducer=(state,action)=>{if(action.type===\"LOAD_CONTACTS\"){const contacts=action.payload;const newContacts=[];contacts.forEach(contact=>{const contactIndex=state.findIndex(c=>c.id===contact.id);if(contactIndex!==-1){state[contactIndex]=contact;}else{newContacts.push(contact);}});return[...state,...newContacts];}if(action.type===\"UPDATE_CONTACTS\"){const contact=action.payload;const contactIndex=state.findIndex(c=>c.id===contact.id);if(contactIndex!==-1){state[contactIndex]=contact;return[...state];}else{return[contact,...state];}}if(action.type===\"DELETE_CONTACT\"){const contactId=action.payload;const contactIndex=state.findIndex(c=>c.id===contactId);if(contactIndex!==-1){state.splice(contactIndex,1);}return[...state];}if(action.type===\"RESET\"){return[];}};const useStyles=makeStyles(theme=>({mainPaper:{flex:1,padding:theme.spacing(1),overflowY:\"scroll\",...theme.scrollbarStyles}}));const ContactListItems=()=>{const classes=useStyles();const{user}=useContext(AuthContext);const{contactListId}=useParams();const history=useHistory();const[loading,setLoading]=useState(false);const[pageNumber,setPageNumber]=useState(1);const[searchParam,setSearchParam]=useState(\"\");const[contacts,dispatch]=useReducer(reducer,[]);const[selectedContactId,setSelectedContactId]=useState(null);const[contactListItemModalOpen,setContactListItemModalOpen]=useState(false);const[deletingContact,setDeletingContact]=useState(null);const[confirmOpen,setConfirmOpen]=useState(false);const[hasMore,setHasMore]=useState(false);const[contactList,setContactList]=useState({});const fileUploadRef=useRef(null);const{findById:findContactList}=useContactLists();useEffect(()=>{findContactList(contactListId).then(data=>{setContactList(data);});// eslint-disable-next-line react-hooks/exhaustive-deps\n},[contactListId]);useEffect(()=>{dispatch({type:\"RESET\"});setPageNumber(1);},[searchParam]);useEffect(()=>{setLoading(true);const delayDebounceFn=setTimeout(()=>{const fetchContacts=async()=>{try{const{data}=await api.get(\"contact-list-items\",{params:{searchParam,pageNumber,contactListId}});dispatch({type:\"LOAD_CONTACTS\",payload:data.contacts});setHasMore(data.hasMore);setLoading(false);}catch(err){toastError(err);}};fetchContacts();},500);return()=>clearTimeout(delayDebounceFn);},[searchParam,pageNumber,contactListId]);useEffect(()=>{const companyId=localStorage.getItem(\"companyId\");const socket=socketConnection({companyId});socket.on(\"company-\".concat(companyId,\"-ContactListItem\"),data=>{if(data.action===\"update\"||data.action===\"create\"){dispatch({type:\"UPDATE_CONTACTS\",payload:data.record});}if(data.action===\"delete\"){dispatch({type:\"DELETE_CONTACT\",payload:+data.id});}if(data.action===\"reload\"){dispatch({type:\"LOAD_CONTACTS\",payload:data.records});}});socket.on(\"company-\".concat(companyId,\"-ContactListItem-\").concat(contactListId),data=>{if(data.action===\"reload\"){dispatch({type:\"LOAD_CONTACTS\",payload:data.records});}});return()=>{socket.disconnect();};},[contactListId]);const handleSearch=event=>{setSearchParam(event.target.value.toLowerCase());};const handleOpenContactListItemModal=()=>{setSelectedContactId(null);setContactListItemModalOpen(true);};const handleCloseContactListItemModal=()=>{setSelectedContactId(null);setContactListItemModalOpen(false);};const hadleEditContact=contactId=>{setSelectedContactId(contactId);setContactListItemModalOpen(true);};const handleDeleteContact=async contactId=>{try{await api.delete(\"/contact-list-items/\".concat(contactId));toast.success(i18n.t(\"contacts.toasts.deleted\"));}catch(err){toastError(err);}setDeletingContact(null);setSearchParam(\"\");setPageNumber(1);};const handleImportContacts=async()=>{try{const formData=new FormData();formData.append(\"file\",fileUploadRef.current.files[0]);await api.request({url:\"contact-lists/\".concat(contactListId,\"/upload\"),method:\"POST\",data:formData});}catch(err){toastError(err);}};const loadMore=()=>{setPageNumber(prevState=>prevState+1);};const handleScroll=e=>{if(!hasMore||loading)return;const{scrollTop,scrollHeight,clientHeight}=e.currentTarget;if(scrollHeight-(scrollTop+100)<clientHeight){loadMore();}};const goToContactLists=()=>{history.push(\"/contact-lists\");};return/*#__PURE__*/_jsxs(MainContainer,{className:classes.mainContainer,children:[/*#__PURE__*/_jsx(ContactListItemModal,{open:contactListItemModalOpen,onClose:handleCloseContactListItemModal,\"aria-labelledby\":\"form-dialog-title\",contactId:selectedContactId}),/*#__PURE__*/_jsx(ConfirmationModal,{title:deletingContact?\"\".concat(i18n.t(\"contactListItems.confirmationModal.deleteTitle\"),\" \").concat(deletingContact.name,\"?\"):\"\".concat(i18n.t(\"contactListItems.confirmationModal.importTitlte\")),open:confirmOpen,onClose:setConfirmOpen,onConfirm:()=>deletingContact?handleDeleteContact(deletingContact.id):handleImportContacts(),children:deletingContact?\"\".concat(i18n.t(\"contactListItems.confirmationModal.deleteMessage\")):/*#__PURE__*/_jsxs(_Fragment,{children:[i18n.t(\"contactListItems.confirmationModal.importMessage\"),/*#__PURE__*/_jsx(\"a\",{href:planilhaExemplo,download:\"planilha.xlsx\",children:\"Clique aqui para baixar planilha exemplo.\"})]})}),/*#__PURE__*/_jsx(MainHeader,{children:/*#__PURE__*/_jsxs(Grid,{style:{width:\"99.6%\"},container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:12,sm:5,item:true,children:/*#__PURE__*/_jsx(Title,{children:contactList.name})}),/*#__PURE__*/_jsx(Grid,{xs:12,sm:7,item:true,children:/*#__PURE__*/_jsxs(Grid,{spacing:2,container:true,children:[/*#__PURE__*/_jsx(Grid,{xs:12,sm:6,item:true,children:/*#__PURE__*/_jsx(TextField,{fullWidth:true,placeholder:i18n.t(\"contactListItems.searchPlaceholder\"),type:\"search\",value:searchParam,onChange:handleSearch,InputProps:{startAdornment:/*#__PURE__*/_jsx(InputAdornment,{position:\"start\",children:/*#__PURE__*/_jsx(SearchIcon,{style:{color:\"gray\"}})})}})}),/*#__PURE__*/_jsx(Grid,{xs:4,sm:2,item:true,children:/*#__PURE__*/_jsx(Button,{fullWidth:true,variant:\"contained\",color:\"primary\",onClick:goToContactLists,children:i18n.t(\"contactListItems.buttons.lists\")})}),/*#__PURE__*/_jsx(Grid,{xs:4,sm:2,item:true,children:/*#__PURE__*/_jsx(Button,{fullWidth:true,variant:\"contained\",color:\"primary\",onClick:()=>{fileUploadRef.current.value=null;fileUploadRef.current.click();},children:i18n.t(\"contactListItems.buttons.import\")})}),/*#__PURE__*/_jsx(Grid,{xs:4,sm:2,item:true,children:/*#__PURE__*/_jsx(Button,{fullWidth:true,variant:\"contained\",color:\"primary\",onClick:handleOpenContactListItemModal,children:i18n.t(\"contactListItems.buttons.add\")})})]})})]})}),/*#__PURE__*/_jsxs(Paper,{className:classes.mainPaper,variant:\"outlined\",onScroll:handleScroll,children:[/*#__PURE__*/_jsx(_Fragment,{children:/*#__PURE__*/_jsx(\"input\",{style:{display:\"none\"},id:\"upload\",name:\"file\",type:\"file\",accept:\".xls,.xlsx\",onChange:()=>{setConfirmOpen(true);},ref:fileUploadRef})}),/*#__PURE__*/_jsxs(Table,{size:\"small\",children:[/*#__PURE__*/_jsx(TableHead,{children:/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{align:\"center\",style:{width:\"0%\"},children:\"#\"}),/*#__PURE__*/_jsx(TableCell,{children:i18n.t(\"contactListItems.table.name\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"contactListItems.table.number\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"contactListItems.table.email\")}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:i18n.t(\"contactListItems.table.actions\")})]})}),/*#__PURE__*/_jsx(TableBody,{children:/*#__PURE__*/_jsxs(_Fragment,{children:[contacts.map(contact=>/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableCell,{align:\"center\",style:{width:\"0%\"},children:/*#__PURE__*/_jsx(IconButton,{children:contact.isWhatsappValid?/*#__PURE__*/_jsx(CheckCircleIcon,{titleAccess:\"Whatsapp V\\xE1lido\",htmlColor:\"green\"}):/*#__PURE__*/_jsx(BlockIcon,{titleAccess:\"Whatsapp Inv\\xE1lido\",htmlColor:\"grey\"})})}),/*#__PURE__*/_jsx(TableCell,{children:contact.name}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:contact.number}),/*#__PURE__*/_jsx(TableCell,{align:\"center\",children:contact.email}),/*#__PURE__*/_jsxs(TableCell,{align:\"center\",children:[/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:()=>hadleEditContact(contact.id),children:/*#__PURE__*/_jsx(EditIcon,{})}),/*#__PURE__*/_jsx(Can,{role:user.profile,perform:\"contacts-page:deleteContact\",yes:()=>/*#__PURE__*/_jsx(IconButton,{size:\"small\",onClick:()=>{setConfirmOpen(true);setDeletingContact(contact);},children:/*#__PURE__*/_jsx(DeleteOutlineIcon,{})})})]})]},contact.id)),loading&&/*#__PURE__*/_jsx(TableRowSkeleton,{columns:4})]})})]})]})]});};export default ContactListItems;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}